<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>派森小草的成长记录</title>
<style>
body {margin:0; font-family: Arial, sans-serif; background-color:#4CAF50;}
.sidebar {
  position: fixed; top:0; left:0; width:250px; height:100vh; background-color:#4CAF50;
  padding:10px; box-sizing:border-box; overflow-y:auto; color:white;
}
.sidebar img {width:100px; height:100px; border-radius:50%; object-fit:cover; display:block; margin:0 auto 10px auto;}
.virtues-list {font-size:14px; line-height:1.4;}
.virtues-list p {margin:4px 0;}

/* 顶部标题 + 月份选择 */
.header {
  position: fixed; top:0; left:250px; right:0; height:50px;
  display:flex; align-items:center; justify-content:space-between;
  background: rgba(0,0,0,0.1); color:white; font-size:18px;
  z-index:10;
  padding:0 20px;
}
.header select, .header button {margin-left:10px; padding:4px 6px; font-size:14px; cursor:pointer;}
.header-avatar {
  width: 35px;           /* 调整头像大小 */
  height: 35px;
  border-radius: 50%;
  object-fit: cover;
}
/* 主内容 */
.main {
  margin-left:250px; padding:60px 20px 20px 20px; display:flex; flex-direction:column; align-items:center;
  overflow-x:auto;
}

/* 打卡表 */
table {border-collapse: collapse; background:white; color:black; font-size:12px; table-layout: fixed;}
td, th {border:1px solid #ddd; text-align:center; padding:2px; width:40px; height:40px; white-space:nowrap;}
.row-title {background:#f0f0f0; font-weight:bold;}
.check-btn {cursor:pointer; border:none; background:none; font-size:12px;}
.diary-btn {cursor:pointer; font-size:12px;}
.diary-text {font-size:10px; word-break:break-word; max-height:30px; overflow:hidden;}

/* 弹窗 */
#diaryModal {display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:white; padding:10px; border:1px solid #aaa; z-index:1000; width:300px;}
#diaryTextarea {width:100%; box-sizing:border-box;}
#overlay {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:999;}
</style>
</head>
<body>

<div class="sidebar">
  <img src="avatar.jpg" alt="我的头像">
  <div class="virtues-list">
    <p>1. 节制：饭不可吃饱，酒不可喝高。</p>
    <p>2. 缄默：于人于己不利的话不谈，避免碎语闲言。</p>
    <p>3. 秩序：放东西各归其位，办事情各按其时。</p>
    <p>4. 决心：决心去做该做的事，做就做到心想事成。</p>
    <p>5. 节俭：不花于己于人没有好处的闲钱，杜绝浪费。</p>
    <p>6. 勤奋：珍惜时光，手里总忙有益之事，剪除一切无谓之举。</p>
    <p>7. 诚信：不害人，不欺诈。思想坦荡，公正；说话实事求是。</p>
    <p>8. 正义：不损人利已，伤天害理的行为永不沾边，利公利民的应尽义务切勿放手。</p>
    <p>9. 中庸：避免走极端。忍让化冤仇。</p>
    <p>10. 清洁：身体、衣着、居所，不许不干不净。</p>
    <p>11. 平静：不可为小事、常事或难免之事搅乱方寸。</p>
    <p>12. 贞洁：少行房事，除非为了身体健康或传宗接代；不要头脑昏沉，身体虚弱。伤害自己或他人的平静或声誉。</p>
    <p>13. 谦卑：效法耶稣和苏格拉底。</p>
  </div>
</div>

<div class="header">
  
  <img src="avatar.jpg" alt="logo" class="header-avatar">
  <span>向下扎根,向上生长</span>
  <div>
    <select id="monthSelect"></select>
    <button id="saveRecords">保存记录</button>
  </div>
</div>

<div class="main">
  <table id="habitTable"></table>
</div>

<!-- 弹窗 -->
<div id="diaryModal">
  <textarea id="diaryTextarea" rows="5"></textarea>
  <div style="text-align:right; margin-top:5px;">
    <button id="diarySaveBtn">保存</button>
    <button id="diaryCancelBtn">取消</button>
  </div>
</div>
<div id="overlay"></div>

<script>
const virtues=["节制","缄默","秩序","决心","节俭","勤奋","诚信","正义","中庸","清洁","平静","贞洁","谦卑"];
const table=document.getElementById("habitTable");
const monthSelect=document.getElementById("monthSelect");
const now=new Date();
for(let i=-6;i<=6;i++){
  const d=new Date(now.getFullYear(), now.getMonth()+i,1);
  const val=d.toISOString().slice(0,7);
  const opt=document.createElement("option");
  opt.value=val; opt.textContent=val;
  if(val===now.toISOString().slice(0,7)) opt.selected=true;
  monthSelect.appendChild(opt);
}

// 弹窗变量
let currentV, currentDay, currentMonth, currentDiaryDiv;
const diaryModal=document.getElementById("diaryModal");
const diaryTextarea=document.getElementById("diaryTextarea");
const overlay=document.getElementById("overlay");

function openDiary(v, day, month, diaryDiv){
  currentV=v; currentDay=day; currentMonth=month; currentDiaryDiv=diaryDiv;
  const data=JSON.parse(localStorage.getItem("habit-"+month)||"{}");
  const prevText=(data[v+"-diary"] && data[v+"-diary"][day])||"";
  diaryTextarea.value=prevText;
  diaryModal.style.display="block";
  overlay.style.display="block";
}

document.getElementById("diarySaveBtn").addEventListener("click",()=>{
  const text=diaryTextarea.value;
  saveDiary(currentMonth, currentV, currentDay, text);
  currentDiaryDiv.textContent=text.length>4?text.slice(0,4)+"…":text;
  currentDiaryDiv.title=text;
  diaryModal.style.display="none";
  overlay.style.display="none";
});

document.getElementById("diaryCancelBtn").addEventListener("click",()=>{
  diaryModal.style.display="none";
  overlay.style.display="none";
});

// 创建表格
function createTable(month){
  table.innerHTML="";
  const firstDay=new Date(month+"-01");
  const year=firstDay.getFullYear();
  const mon=firstDay.getMonth();
  const daysInMonth=new Date(year,mon+1,0).getDate();

  const header=table.insertRow();
  header.insertCell().textContent="德/日";
  for(let d=1;d<=daysInMonth;d++){
    const th=document.createElement("th");
    th.textContent=d;
    header.appendChild(th);
  }

  virtues.forEach(v=>{
    const row=table.insertRow();
    row.insertCell().textContent=v;
    row.cells[0].className="row-title";

    for(let d=1;d<=daysInMonth;d++){
      const cell=row.insertCell();

      const btn=document.createElement("button");
      btn.className="check-btn";
      btn.dataset.day=d-1;
      btn.textContent="❌";
      btn.addEventListener("click",()=>{ btn.textContent=btn.textContent==="❌"?"✅":"❌"; });

      const diaryBtn=document.createElement("button");
      diaryBtn.className="diary-btn";
      diaryBtn.textContent="📝";

      const diaryText=document.createElement("div");
      diaryText.className="diary-text";

      diaryBtn.addEventListener("click",()=>{ openDiary(v,d-1,month,diaryText); });

      cell.appendChild(btn);
      cell.appendChild(document.createElement("br"));
      cell.appendChild(diaryBtn);
      cell.appendChild(diaryText);
    }
  });

  loadMonth(month);
}

// 保存日记
function saveDiary(month, virtue, day, text){
  const data=JSON.parse(localStorage.getItem("habit-"+month)||"{}");
  if(!data[virtue+"-diary"]) data[virtue+"-diary"]={};
  data[virtue+"-diary"][day]=text;
  localStorage.setItem("habit-"+month,JSON.stringify(data));
}

// 保存打卡记录
document.getElementById("saveRecords").addEventListener("click",()=>{
  const month=monthSelect.value;
  const data={};
  const rows=Array.from(table.rows).slice(1);
  rows.forEach(r=>{
    const virtue=r.cells[0].textContent;
    data[virtue]=[];
    for(let i=1;i<r.cells.length;i++){
      data[virtue].push(r.cells[i].querySelector(".check-btn").textContent);
    }
  });
  const oldData=JSON.parse(localStorage.getItem("habit-"+month)||"{}");
  const mergedData={...oldData,...data};
  localStorage.setItem("habit-"+month,JSON.stringify(mergedData));
  alert("已保存记录");
});

// 加载月份
function loadMonth(month){
  const data=JSON.parse(localStorage.getItem("habit-"+month)||"{}");
  const rows=Array.from(table.rows).slice(1);
  rows.forEach(r=>{
    const virtue=r.cells[0].textContent;
    for(let i=1;i<r.cells.length;i++){
      const btn=r.cells[i].querySelector(".check-btn");
      if(data[virtue] && data[virtue][i-1]) btn.textContent=data[virtue][i-1];
      const diaryDiv=r.cells[i].querySelector(".diary-text");
      if(data[virtue+"-diary"] && data[virtue+"-diary"][i-1]){
        const text=data[virtue+"-diary"][i-1];
        diaryDiv.textContent=text.length>4?text.slice(0,4)+"…":text;
        diaryDiv.title=text;
      }
    }
  });
}

// 切换月份
monthSelect.addEventListener("change",()=> createTable(monthSelect.value));

// 初始化
createTable(monthSelect.value);
</script>
</body>
</html>
